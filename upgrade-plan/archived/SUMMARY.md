# 升级计划概要

## 项目概述

**nanobot** 是一个超轻量级个人 AI 助理，代码量仅约 4000 行。本次升级将增强其任务处理能力，实现动态子代理协调和执行监控。

## 旧架构的关键特点

### 1. 核心组件

- **Agent Loop**：单一循环处理所有消息，使用 SessionManager 管理会话
- **Subagent Manager**：支持后台任务执行，但通信单向且无状态跟踪
- **Message Bus**：内部消息路由系统，支持系统消息通知
- **Cron Service**：定时任务系统，支持简单的任务调度

### 2. 主要限制

- 子代理任务不可修正
- 无任务状态跟踪和进度汇报
- 消息处理串行化，无优先级机制
- 任务监控和错误处理简单

## 新架构的设计要点

### 1. 核心创新

#### 1.1 任务管理框架

```python
class TaskManager:
    """
    任务管理和协调中心：
    - 跟踪所有运行中的子代理任务
    - 管理任务状态和进度
    - 处理任务修正和重新执行
    - 提供任务查询接口
    """
```

#### 1.2 增强的子代理管理

```python
class EnhancedSubagentManager(SubagentManager):
    """
    增强的子代理管理：
    - 支持任务状态跟踪
    - 提供任务修正接口
    - 实时进度汇报
    - 子代理生命周期管理
    """
```

#### 1.3 智能消息分析

```python
class MessageAnalyzer:
    """
    分析消息与任务的关联：
    - 语义相似度分析
    - 任务相关性识别
    - 决定创建新任务还是修正现有任务
    """
```

#### 1.4 任务监控系统

```python
class TaskMonitor:
    """
    任务监控器：
    - 每小时检查任务执行状态
    - 识别执行问题
    - 自动修正和更新计划
    """
```

### 2. 架构图

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Chat Apps   │────►│ Message Bus  │────►│  Agent Loop  │
└──────────────┘     └──────────────┘     └──────────────┘
         ▲                     ▲                   │
         │                     │                   ▼
         │                     │            ┌──────────────┐
         │                     │            │ Task Manager │
         │                     │            └──────────────┘
         │                     │                   │
         │                     │            ┌──────────────┐
         │                     └────────────┤ Subagents    │
         │                                  └──────────────┘
         │                                          │
         │                                          ▼
         └──────────────────────────────────────┐ Cron Job    │
                                                └──────────────┘
```

## 主要代码变更清单

### 新增文件

| 文件路径 | 功能描述 |
|---------|---------|
| nanobot/agent/task.py | 任务数据模型 |
| nanobot/agent/task_manager.py | 任务管理器 |
| nanobot/bus/message_analyzer.py | 消息分析器 |
| nanobot/monitor/progress_tracker.py | 进度跟踪器 |
| nanobot/cron/monitor.py | 任务监控器 |
| upgrade-plan/cron-job-config.json | Cron 任务配置 |
| upgrade-plan/test-scenarios.md | 测试场景 |
| upgrade-plan/deployment-guide.md | 部署指南 |

### 修改文件

| 文件路径 | 修改内容 |
|---------|---------|
| nanobot/agent/subagent.py | 增强子代理管理，支持任务状态和修正 |
| nanobot/agent/loop.py | 集成任务管理和消息分析 |
| nanobot/bus/events.py | 新增任务相关事件类型 |
| nanobot/bus/queue.py | 优化消息路由 |
| nanobot/cron/types.py | 新增任务监控类型 |
| nanobot/cron/service.py | 支持新任务类型执行 |

## Cron Job 配置详情

### 监控任务配置

**文件**：`upgrade-plan/cron-job-config.json`

```json
{
  "version": "1.0",
  "jobs": [
    {
      "id": "task-progress-monitor",
      "name": "Task Progress Monitor",
      "enabled": true,
      "schedule": {
        "kind": "cron",
        "expr": "0 * * * *",
        "tz": "Asia/Shanghai"
      },
      "payload": {
        "kind": "monitor",
        "message": "Check task execution progress and status. If any issues are found, correct the plan and update execution actions.",
        "deliver": true,
        "channel": "cli"
      }
    }
  ]
}
```

### 任务功能

1. **执行时间**：每小时的第 0 分钟
2. **时区**：亚洲/上海时区
3. **功能**：
   - 检查所有任务的执行状态和进度
   - 识别任务执行中的问题
   - 自动修正和更新计划
   - 发送执行状态报告

## 风险评估和注意事项

### 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 消息分析精度 | 任务关联错误导致修正失败 | 使用更强大的语义相似度模型，提供手动修正选项 |
| 子代理资源消耗 | 大量子代理导致系统过载 | 实现子代理资源限制和自动伸缩 |
| 任务状态一致性 | 子代理状态与任务管理器不同步 | 使用心跳机制定期同步状态 |

### 业务风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 用户体验 | 任务修正可能导致混淆 | 清晰的任务状态展示和进度更新 |
| 任务失败 | 重要任务失败未及时通知 | 增强错误通知机制，支持任务重试 |

### 部署风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 数据迁移 | 现有任务数据不兼容 | 提供数据迁移工具和回滚方案 |
| 配置错误 | 服务启动失败 | 提供配置验证工具和详细文档 |
| 性能下降 | 系统响应变慢 | 性能测试和优化 |

### 注意事项

1. **数据迁移**：现有的任务状态可能需要迁移到新的任务管理系统
2. **API 兼容性**：确保与现有工具和技能的兼容性
3. **性能监控**：部署后需要密切监控系统资源使用情况
4. **回滚方案**：准备回滚到旧版本的方案，如需要

## 版本规划

### v0.2.0 - 基础任务管理 (预计完成时间：1周)

- 任务管理框架
- 增强子代理管理
- 基本消息路由

### v0.2.1 - 消息分析和任务修正 (预计完成时间：2周)

- 消息分析器
- 任务修正机制
- 进度跟踪

### v0.2.2 - 定时监控任务 (预计完成时间：2.5周)

- 任务监控器
- 自动修正机制
- Cron 任务配置

### v0.2.3 - 性能优化和测试 (预计完成时间：3周)

- 性能优化
- 全面测试
- 部署验证

## 总结

本次升级将显著提升 nanobot 的任务处理能力，实现：

1. **动态任务管理**：根据用户消息智能创建和修正任务
2. **实时进度汇报**：子代理执行过程中提供进度更新
3. **自动监控**：每小时检查任务状态，自动修正问题
4. **更好的用户体验**：清晰的任务状态展示和进度反馈

这些改进将使 nanobot 能够处理更复杂的任务场景，为用户提供更可靠和高效的服务。
