# 架构分析报告

## 1. 项目概述

**nanobot** 是一个超轻量级个人 AI 助理，代码量仅约 4000 行，提供核心的 Agent 功能。项目采用模块化设计，包含以下主要组件：

- **核心 Agent**：处理消息、工具执行、会话管理
- **子代理系统**：支持后台任务执行
- **聊天通道**：Telegram/WhatsApp/Feishu 集成
- **定时任务**：Cron 服务用于周期性任务
- **消息总线**：内部消息路由系统

## 2. 现有架构分析

### 2.1 核心 Agent 循环 (agent/loop.py)

```python
class AgentLoop:
    """
    核心处理引擎：
    1. 从总线接收消息
    2. 构建上下文（历史记录、记忆、技能）
    3. 调用 LLM
    4. 执行工具调用
    5. 发送响应
    """
```

**关键流程**：
- 单一循环处理所有消息
- 使用 SessionManager 管理会话状态
- 内置工具注册表支持多种工具类型
- 支持子代理（SubagentManager）

### 2.2 子代理管理 (agent/subagent.py)

```python
class SubagentManager:
    """
    管理后台子代理执行：
    - 轻量级 Agent 实例在后台运行
    - 共享 LLM 提供者但拥有独立上下文
    - 完成后通过系统消息通知主 Agent
    """
```

**当前限制**：
- 子代理无法接收新消息修正任务
- 无任务状态跟踪和进度汇报
- 子代理与主 Agent 通信单向

### 2.3 聊天通道 (channels/manager.py)

```python
class ChannelManager:
    """
    管理聊天通道和消息路由：
    - 初始化启用的通道（Telegram/WhatsApp/Feishu）
    - 启动/停止通道
    - 路由输出消息
    """
```

### 2.4 定时任务系统 (cron/service.py)

```python
class CronService:
    """
    定时任务管理：
    - 支持 at/every/cron 三种调度类型
    - 任务持久化到本地存储
    - 执行时调用回调函数
    """
```

## 3. 消息处理流程

### 3.1 简化的架构图

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Chat Apps   │────►│ Message Bus  │────►│  Agent Loop  │
└──────────────┘     └──────────────┘     └──────────────┘
                              ▲                │
                              │                ▼
                              │           ┌──────────────┐
                              │           │ Subagents    │
                              │           └──────────────┘
                              │                │
                              └────────────────┘
```

### 3.2 当前消息流转

1. **输入阶段**：Chat Apps 接收用户消息 → 转换为 InboundMessage → 放入消息总线
2. **处理阶段**：AgentLoop 从总线消费消息 → 构建上下文 → 调用 LLM → 执行工具
3. **子代理阶段**：通过 SpawnTool 调用子代理 → 子代理执行任务 → 完成后发送系统消息
4. **输出阶段**：生成 OutboundMessage → 消息总线 → ChannelManager 发送到对应通道

## 4. 架构缺陷和改进机会

### 4.1 子代理协调缺陷

| 问题 | 影响 |
|------|------|
| 子代理任务不可修正 | 一旦启动，无法根据新消息调整任务 |
| 无进度汇报 | 主 Agent 无法知道子代理执行状态 |
| 单向通信 | 子代理只能向主 Agent 发送结果，无法接收指令 |

### 4.2 消息处理限制

| 问题 | 影响 |
|------|------|
| 串行处理 | 所有消息按顺序处理，无优先级机制 |
| 会话状态管理简单 | 会话状态仅基于 session_key，无更灵活的关联机制 |
| 消息路由有限 | 系统消息路由仅支持简单的 origin_channel:origin_chat_id 格式 |

### 4.3 定时任务局限性

| 问题 | 影响 |
|------|------|
| 任务类型单一 | 仅支持 agent_turn 类型任务 |
| 无任务执行监控 | 无法获取任务执行进度和状态 |
| 错误处理简单 | 失败后仅记录错误，无自动修正机制 |
